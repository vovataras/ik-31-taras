# Lab_5: Автоматизація за допомогою Makefile VS Docker Compose

## Makefile
1. Створюю папку `my_app` в якій буде знаходитись проект. Створюю папку `tests` де будуть тести на перевірку працездатності проекту. 
2. Копіюю файли з репозиторію `devops_course` у відповідні папки свого. Ознайомлююсь із вмістом кожного з файлів.
3. Пробую чи проект є працездатним перейшовши у папку та після ініціалізації середовища виконую команди записані нижче:

        pipenv --python 3.7
        pipenv install -r requirements.txt
        pipenv run python app.py
    
    * Проте появляється помилка при перегляді сторінок сайту: `redis.exceptions.ConnectionError`. Проблема полягає в тому, що відсутій `redis-сервер` і сайт не може доступитись до нього;
    * Встановлюю `redis-сервер` використовуючи команду `sudo apt-get install redis-server`;
    * Після встановлення в мене він запустився самостійно, проте для запуску використовується команда `sudo systemctl start redis`;
    * Також прописую `127.0.0.1 redis` в `/etc/hosts`, тому, що система не може зрозуміти `'redis'` при підключенні до сервера;
    * Після цього головна сторіна працює:
    
    ![main_page](images/lab_5_1.png)
    * Сторінки `/hits` та `/logs` не працюють, оскільки відсутня папка `logs` в папці з додатком, тому створюю її;
    * Після цього сторінки `/hits` та `/logs` працюють:
    
    ![/hits](images/lab_5_2.png)
    
    ![/logs](images/lab_5_3.png)  
4. Так само можна ініціалузувати середовище для тестів у іншій вкладці шелу та запустити їх командою:
    
        pipenv run pytest test_app.py --url http://localhost:5000
    
    * Тести пройшли успішно:
    
    ![tests](images/lab_5_4.png) 

5. Видаляю файли які постворювались після тестового запуску (`Pipfile` та `Pipfile.lock`, а також папку `.virtualenvs`).
6. Щоб середовище було чистим, все буде створюватись і виконуватись всередині `Docker`. Створюю два `Dockerfile` з іменами як у репозиторію `devops_course` та `Makefile` який допоможе автоматизувати процес розгортання.
7. Ознайомлююсь із вмістом `Dockerfile` та `Makefile` та його директивами. 
    * `STATES` та `REPO` це змінні, які містять назви тегів та назву репозиторія відповідно;
    * Директива `.PHONY` підставляючи значення з змінної `STATES` викликає директиву `$(STATES)`;
    * `$(STATES)` можна викликати просто підставляючи назву тегу і призначена для білду Docker Image;
    * `run` для запуску сайту та `redis`;
    * `test-app` для запуску тестів;
    * `docker-prune` для очищення ресурсів Docker;
8. Для початку, використовуючи команду `make` створюю Docker імеджі для додатку та для тестів:
        
        make .PHONY 
        
9. Запускаю додаток та перейшовши в іншу вкладку шелу запускаю тести. 
    * Тести пройшли успішно:
    
    ![tests](images/lab_5_5.png)
    
    ![app](images/lab_5_6.png)
    
    * Сторінки сайту:
    
    ![main_page](images/lab_5_7.png)
    
    ![/hits](images/lab_5_8.png)
    
    ![/logs](images/lab_5_9.png)
    
10. Зупиняю проект натиснувши `Ctrl+C` та чищу всі ресурси `Docker` за допомогою `make`.

        make docker-prune
        
11. Створюю директиву в `Makefile` для завантаження створених імеджів у Ваш `Docker Hub` репозиторій. Завантажую імеджі до репозиторію:
        
        make push
        
    [Репозиторій Docker Hub](https://hub.docker.com/repository/docker/vovataras/lab5-examples/general)

12. Також видаляю створені та закачані імеджі. Створюю директиву в `Makefile` яка автоматизує процес видалення імеджів.

    ![docker images](images/lab_5_10.png)

---    
## docker-compose.yaml

1. Створюю файл `docker-compose.yaml` у кореновій папці проекту та заповнюю вмістом з прикладу. 
    * Він містить дві мережі: `secret` та `public`; 
    * Це потрібно для того, щоб відокремити `redis` від доступу з зовнішніх ресурсів;
    * Тобто `redis` знаходиться в `private`, `tests` в `public`, тому `tests` не може доступитись до `redis`.
2. Перевіряю чи `Docker-compose` встановлений та працює у системі, а далі просто запускаю docker-compose:
   
        docker-compose version
        docker-compose -p lab5 up

3. Перевіряю чи працює веб-сайт. У браузері заходжу на адресу: `http://127.0.0.1/`:
    
    ![mainpage](images/lab_5_11.png)
    
    ![/hits](images/lab_5_12.png)
    
    ![/logs](images/lab_5_13.png)
    
4. Перевіряю чи компоуз створив докер імеджі. 
    * Теги `compose-tests`, `compose-app`:
    
    ![docker-images](images/lab_5_14.png)
    
    * Замінюю їх на власний репозиторій і перезапускаю `docker-compose`, почиститивши перед цим імеджі за допомогою `make`:
    
    ![docker-images](images/lab_5_15.png)
    
5. Зупиняю проект натиснувши `Ctrl+C` і чищу ресурси створені компоуз `docker-compose down`.

    ![docker-images](images/lab_5_16.png)
    
6. Завантажую створені імеджі до `Docker Hub` репозиторію за допомого команди:

        sudo docker-compose push

---        
## Makefile vs. docker-compose.yaml 
`Docker-compose` це простий інструмент, який дозволяє налаштувати і запустити кілька контейнерів однією командою.

В `Makefile` можна прописати власні директиви називаючи їх як завгодно та надаючи їм певні правила для команд. В цьому плані `Makefile` більш гнучкий, проте через це його важче реалізовувати.

Коли контейнер один, можна можна використовувати `Makefile`.

Проте коли є декілька контейнерів, краще використовувати `docker-compose`, оскільки він допомагає управляти не просто одним, а всіма контейнерами, які складають розподілений додаток. Причому, не тільки контейнерами, а й мережами, підключеними папками і всіма пов'язаними з цим настройками.

---
## Завдання
1. Cтворюю docker-compose.yaml для лабораторної №4 (його можна знайти [тут](../lab_4/docker-compose.yml)).
2. Запускаю компоуз командою:
    
        docker-compose -p lab4 up

    ![docker-compose lab4](images/lab_5_17.png)
    
3. Перевіряю чи працюють сторінки:

    ![mainpage lab4](images/lab_5_18.png)
    
    ![/health lab4](images/lab_5_19.png)
    
4. Зупиняю компоуз. Витягую файл [server.log](server.log) з підмонтованого `volume`.
5. Заливаю імеджі на [Docker Hub репозиторій](https://hub.docker.com/repository/docker/vovataras/lab4-examples).
